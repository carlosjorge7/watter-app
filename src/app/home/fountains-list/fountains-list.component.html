<ion-header>
  <ion-toolbar color="primary">
    <ion-title>
      <div class="header-content">
        <div>
          <h2>
            {{ isFavoritesMode ? "Fuentes Favoritas" : "Listado de fuentes" }}
          </h2>
          <p>
            {{ allFilteredResults.length }}
            @if (hasActiveFilters()) { de {{ fountains.length }} } fuentes @if
            (hasActiveFilters()) { encontradas } @if (filteredFountains.length <
            allFilteredResults.length) { (mostrando
            {{ filteredFountains.length }}) }
          </p>
        </div>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="closeModal()">
        <ion-icon name="close" size="large"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content
  class="ion-padding"
  [scrollEvents]="true"
  (ionScroll)="onScroll($event)"
>
  @if (initialLoad) {
  <div class="loading-state">
    <ion-spinner color="primary"></ion-spinner>
    <p>Procesando fuentes...</p>
  </div>
  } @if (!initialLoad) {
  <div>
    @if (!isFavoritesMode) {
    <div class="filters-section">
      <div class="filter-row">
        <ion-item class="district-select">
          <ion-select
            [(ngModel)]="selectedDistrict"
            (ionChange)="filterFountains(true)"
            placeholder="Selecciona distrito para filtrar"
            interface="popover"
          >
            <ion-select-option value="">Filtrar por distrito</ion-select-option>
            @for (district of districts; track district) {
            <ion-select-option [value]="district">{{
              district
            }}</ion-select-option>
            }
          </ion-select>
        </ion-item>

        <ion-item class="usage-select">
          <ion-select
            [(ngModel)]="selectedUsage"
            (ionChange)="filterFountains(true)"
            placeholder="Filtrar por uso"
            interface="popover"
          >
            <ion-select-option value="">Todos los usos</ion-select-option>
            <ion-select-option value="personas"
              >Solo personas</ion-select-option
            >
            <ion-select-option value="mascotas"
              >Personas y mascotas</ion-select-option
            >
          </ion-select>
        </ion-item>

        @if (hasActiveFilters()) {
        <ion-button
          fill="clear"
          size="small"
          color="medium"
          (click)="clearFilters()"
          class="clear-filters-btn"
        >
          <ion-icon name="close" slot="start"></ion-icon>
          Limpiar
        </ion-button>
        }
      </div>
    </div>
    }

    <div class="fountains-grid">
      @for (fountain of filteredFountains; track $index) {
      <ion-card class="fountain-card" (click)="openFountainDetail(fountain)">
        <ion-card-content>
          <!-- Header con título y estado -->
          <div class="fountain-header">
            <div class="fountain-title">
              <h3>{{ fountain.DISTRITO }} - {{ fountain.BARRIO }}</h3>
              <div class="status-badges">
                <ion-chip
                  [color]="getStatusColor(fountain.ESTADO!)"
                  class="status-chip"
                >
                  <ion-icon
                    [name]="getStatusIcon(fountain.ESTADO!)"
                    slot="start"
                  ></ion-icon>
                  <ion-label>{{ getStatusText(fountain.ESTADO!) }}</ion-label>
                </ion-chip>

                <ion-chip [color]="getUsageColor(fountain)" class="usage-chip">
                  <ion-icon
                    [name]="getUsageIcon(fountain)"
                    slot="start"
                  ></ion-icon>
                  <ion-label>{{ getUsage(fountain) }}</ion-label>
                </ion-chip>
              </div>
            </div>
          </div>

          <!-- Coordenadas mejoradas -->
          <div class="coordinates-section">
            <div class="coordinate-item">
              <ion-icon name="location" color="primary"></ion-icon>
              <div class="coordinate-data">
                <span class="coordinate-label">Coordenadas</span>
                <span class="coordinate-value">
                  {{ fountain.LATITUD | number : "1.6-6" }},
                  {{ fountain.LONGITUD | number : "1.6-6" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Botones de acción mejorados -->
          <div class="fountain-actions">
            <div class="primary-actions">
              <ion-button
                fill="solid"
                size="default"
                color="primary"
                shape="round"
                expand="block"
                (click)="goToMap(fountain, $event)"
              >
                <ion-icon name="map" slot="start"></ion-icon>
                Ver en mapa
              </ion-button>
            </div>

            <div class="secondary-actions">
              <ion-button
                fill="outline"
                size="default"
                color="secondary"
                shape="round"
                (click)="shareLocation(fountain, $event)"
              >
                <ion-icon name="share" slot="start"></ion-icon>
                Compartir
              </ion-button>

              <ion-button
                [fill]="(isFavorite(fountain) | async) ? 'solid' : 'outline'"
                size="default"
                [color]="(isFavorite(fountain) | async) ? 'danger' : 'medium'"
                shape="round"
                (click)="toggleFavorite(fountain, $event)"
              >
                <ion-icon
                  [name]="
                    (isFavorite(fountain) | async) ? 'heart' : 'heart-outline'
                  "
                  slot="start"
                ></ion-icon>
                {{ (isFavorite(fountain) | async) ? "Quitar" : "Favorito" }}
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
      } @empty {
      <div class="empty-state">
        <ion-icon name="search" size="large" color="medium"></ion-icon>
        <h3>No se encontraron fuentes</h3>
        <p>Intenta cambiar los filtros de búsqueda</p>
      </div>
      } @if (isLoading && !initialLoad) {
      <div class="loading-more">
        <ion-spinner color="primary"></ion-spinner>
        <p>Cargando más fuentes...</p>
      </div>
      } @if (!hasMoreItems && !isLoading && filteredFountains.length > 0) {
      <div class="no-more-items">
        <p>No hay más fuentes que mostrar</p>
      </div>
      }
    </div>
  </div>
  }
</ion-content>
